<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>E-LEDGER KAKINADA</title>
<style>
  body { margin:0; min-height:100vh; font-family: Arial, sans-serif; animation: gradientBG 18s ease infinite; background: linear-gradient(120deg, #43e97b 0%, #38f9d7 100%); background-size: 400% 400%; }
  @keyframes gradientBG {0% {background-position:0% 50%;} 50% {background-position:100% 50%;} 100% {background-position:0% 50%;}}
  .container {max-width: 1100px; margin: 45px auto; background: rgba(255,255,255,0.98); border-radius: 18px; box-shadow: 0 10px 48px 0 #1c50a322; padding: 36px 30px 30px 30px;}
  h1,h2 {text-align:center; color:#1b336a; letter-spacing:2px; margin-bottom:0.2em;}
  h2 { color:#4f8cff; font-size:1.2em; margin-bottom:1.4em; margin-top:0; }
  .row { display:flex; gap:15px; margin-bottom:25px; flex-wrap:wrap; position:relative; }
  input,select,textarea { flex:1; padding:10px; border:1px solid #b3d0ed; border-radius:5px; background:#f6faff; font-size:1em;}
  .suggestions { position:absolute; left:0;right:0;top:44px; background:#fff; border:1px solid #b3d0ed; z-index:99; border-top:none; max-height:200px; overflow-y:auto; }
  .suggestion { padding:9px 12px; cursor:pointer; border-bottom:1px solid #eef2fa; }
  .suggestion:last-child { border-bottom:none; }
  .suggestion:hover { background:#eaf8ff; }
  .item-table { margin-top:25px; }
  table { width:100%; border-collapse:collapse; margin-top:6px;}
  th,td { padding:10px 7px; text-align:left; vertical-align:middle;}
  th { background:#9ad3fb; color:#1b336a;}
  tr:nth-child(even) {background:#f4f9fe;}
  .editable,.editable-name-input { background:#fff9db; border:1px solid #ffb84c; border-radius:4px; padding:5px 6px; font-family:inherit; font-size:1em;}
  .editable-name-input { width:90%;}
  .textarea-editable { background:#fff9db; border:1px solid #ffb84c; border-radius:4px; padding:6px; min-height:65px; font-size:0.95em; font-family:Arial, sans-serif; width:100%; box-sizing:border-box; resize:vertical;}
  .save-btn, .download-btn, .delete-btn, .edit-name-btn, .save-name-btn { cursor:pointer; border:none; border-radius:5px; padding:6px 16px; margin:6px 4px 6px 0; font-weight:bold; font-size:1em; transition:background 0.18s;}
  .save-btn, .download-btn { background:#43e97b; color:#222;}
  .save-btn:hover, .download-btn:hover, .save-name-btn:hover, .edit-name-btn:hover {background:#38f9d7;}
  .delete-btn { background:#e35b5b; color:#fff;}
  .delete-btn:hover { background:#c94b4b;}
  .history-title { font-weight:bold; margin-top:15px; margin-bottom:8px;}
  .history-table { width:100%; font-size:0.9em; border-collapse:collapse; margin-top:15px;}
  .history-table th, .history-table td { border:1px solid #b3d0ed; padding:8px 6px; vertical-align:middle; text-align:center;}
  .history-delete { cursor:pointer; border:none; border-radius:4px; padding:2px 6px; font-weight:bold; background:#e35b5b; color:white;}
  .history-delete:hover { background:#c94b4b;}
  .history-remark-edit { width:90%; max-width:220px; height:40px; padding:3px 5px; resize:vertical; font-family:Arial, sans-serif; font-size:0.95em;}
  .received { color: #2d862d; font-weight: bold;}
  .sent { color: #cc4c4c; font-weight: bold;}
  #authorize_button, #signout_button { margin: 10px; padding: 10px 15px; font-weight: bold; font-size: 1em; border-radius: 5px; cursor: pointer; }
  #authorize_button { background-color: #4285f4; color: white; }
  #signout_button { background-color: #db4437; color: white; display: none; }
  .radio-row { text-align:center; margin-bottom:25px;}
  .radio-row label { font-size:1.18em; margin:0 10px 0 0;}
  .radio-row input[type="radio"] { margin:0 10px 0 18px;}
  @media (max-width: 600px) {
    .container { padding: 20px 15px; }
    .row { flex-direction: column; }
    input, select, textarea { flex: unset; width: 100%; margin-bottom: 12px;}
  }
</style>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
</head>
<body>
<div class="container">
  <h1>E-LEDGER KAKINADA</h1>
  <h2>SELECT VOLUME</h2>
  <div class="radio-row" id="volumeSelector">
    <label><input type="radio" name="volume" value="1" id="vol1" checked> VOLUME-I</label>
    <label><input type="radio" name="volume" value="2" id="vol2"> VOLUME-II</label>
  </div>
  <button id="authorize_button">Authorize Google Sheets Access</button>
  <button id="signout_button">Sign Out</button>
  <div class="row">
    <input type="text" id="searchBar" placeholder="Search stock item..." />
    <div id="suggestions" class="suggestions" style="display:none"></div>
    <select id="dropdown"><option value="">Select stock item...</option></select>
  </div>
  <div class="item-table" id="itemTable"></div>
  <div class="button-row">
    <button class="download-btn" id="downloadBtn">Download Excel File</button>
  </div>
</div>
<script>
const CLIENT_ID = '619112892635-urou1b9gfjvas0njof9ibdjip5dbjbbc.apps.googleusercontent.com';
const API_KEY = 'AIzaSyCqK9TL0c3FMZA0Xyg16Ij0dKDskNsNGws';
const SPREADSHEET_ID = '1trGV_sR93c7ksN1-0C4RlRQF2c-c9tHCJ_2yHi94ylY';
// Sheets for each volume:
const VOLUMES = {
  1: { ITEM: 'Sheet1', HISTORY: 'StockHistory' },
  2: { ITEM: 'Sheet2', HISTORY: 'StockHistory2' }
};
let currentVolume = 1; // Default is VOLUME-I

const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
let tokenClient, gapiInited = false, gisInited = false;
let items = [], currentItem = null;

const searchBar = document.getElementById('searchBar');
const suggestionsDiv = document.getElementById('suggestions');
const dropdown = document.getElementById('dropdown');
const itemTable = document.getElementById('itemTable');
const downloadBtn = document.getElementById('downloadBtn');
const authorizeBtn = document.getElementById('authorize_button');
const signoutBtn = document.getElementById('signout_button');
const radioVol1 = document.getElementById('vol1');
const radioVol2 = document.getElementById('vol2');

radioVol1.onclick = ()=>{ if(currentVolume !== 1){ currentVolume=1; if(gapi.client.getToken()) loadData(); }};
radioVol2.onclick = ()=>{ if(currentVolume !== 2){ currentVolume=2; if(gapi.client.getToken()) loadData(); }};

function getItemSheet()   { return VOLUMES[currentVolume].ITEM; }
function getHistorySheet(){ return VOLUMES[currentVolume].HISTORY; }

function gapiLoaded() { gapi.load('client', initializeGapiClient);}
async function initializeGapiClient() {
  await gapi.client.init({apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC]});
  gapiInited = true; maybeEnableButtons();
}
function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '',});
  gisInited = true; maybeEnableButtons();
}
function maybeEnableButtons() { if (gapiInited && gisInited) authorizeBtn.style.visibility = 'visible'; }
authorizeBtn.onclick = () => {
  tokenClient.callback = async(resp) => {
    if (resp.error !== undefined) throw(resp);
    authorizeBtn.style.display = 'none';
    signoutBtn.style.display = 'inline-block';
    await loadData();
  };
  if (!gapi.client.getToken()) tokenClient.requestAccessToken({prompt:'consent'});
  else tokenClient.requestAccessToken({prompt:''});
};
signoutBtn.onclick = () => {
  const token = gapi.client.getToken();
  if (token) {
    google.accounts.oauth2.revoke(token.access_token);
    gapi.client.setToken('');
    authorizeBtn.style.display = 'inline-block';
    signoutBtn.style.display = 'none';
    items = [];
    currentItem = null;
    itemTable.innerHTML = '';
    dropdown.innerHTML = '<option value="">Select stock item...</option>';
    searchBar.value = '';
    suggestionsDiv.style.display = 'none';
    alert('Signed out successfully.');
  }
};

async function loadData() {
  await loadStockItems();
  await loadStockHistory();
  populateDropdown();
  if (items.length) showItem(items[0]);
  else itemTable.innerHTML = 'No items found.';
}
async function loadStockItems() {
  const range = `${getItemSheet()}!A2:E`;
  const response = await gapi.client.sheets.spreadsheets.values.get({spreadsheetId: SPREADSHEET_ID, range});
  const rows = response.result.values || [];
  items = rows.map((row, i) => ({
    sno: Number(row[0]) || i+1,
    name: (row[1] || '').trim(),
    stock: Number(row[2]) || 0,
    page: row[3] || '',
    notes: row[4] || '',
    history: []
  })).filter(i => i.name);
}
async function loadStockHistory() {
  const range = `${getHistorySheet()}!A2:F`;
  const response = await gapi.client.sheets.spreadsheets.values.get({spreadsheetId: SPREADSHEET_ID, range});
  const rows = response.result.values || [];
  const map = {};
  rows.forEach(r => {
    const [itemName, date, oldStock, newStock, receivedSent, remark] = r;
    if (!itemName) return;
    if (!map[itemName]) map[itemName] = [];
    map[itemName].push({
      date, old: Number(oldStock), new: Number(newStock), receivedSent, remark
    });
  });
  items.forEach(item => item.history = map[item.name] || []);
}
function populateDropdown() {
  dropdown.innerHTML = '<option value="">Select stock item...</option>';
  items.forEach(i=>{
    if(i.name){
      const opt = document.createElement('option');
      opt.value = i.sno;
      opt.textContent = i.name;
      dropdown.appendChild(opt);
    }
  });
}
searchBar.addEventListener('input', () =>{
  const val = searchBar.value.toLowerCase().trim();
  suggestionsDiv.innerHTML = '';
  if(!val){suggestionsDiv.style.display = 'none'; return;}
  const filtered = items.filter(i=>i.name.toLowerCase().includes(val));
  filtered.forEach(i=>{
    const div = document.createElement('div');
    div.className = 'suggestion';
    div.textContent = `${i.name} (Stock: ${i.stock}, Pg: ${i.page})`;
    div.onclick = ()=>{
      showItem(i);
      searchBar.value = i.name;
      dropdown.value = i.sno;
      suggestionsDiv.style.display = 'none';
    };
    suggestionsDiv.appendChild(div);
  });
  suggestionsDiv.style.display = filtered.length ? 'block' : 'none';
});
document.addEventListener('click', e =>{
  if(!suggestionsDiv.contains(e.target) && e.target !== searchBar) suggestionsDiv.style.display = 'none';
});
dropdown.addEventListener('change', ()=>{
  const sno = parseInt(dropdown.value);
  if(!sno) return;
  const item = items.find(i=>i.sno === sno);
  if(item){
    showItem(item);
    searchBar.value = item.name;
  }
});

function renderHistoryTable(item){
  if(!item.history.length) return '<div>No stock change history.</div>';
  let html = `<div class="history-title">Stock Change History</div><table class="history-table"><thead><tr><th>#</th><th>Date & Time</th><th>Old Stock</th><th>New Stock</th><th>Received/Sent</th><th>Remarks</th><th>Actions</th></tr></thead><tbody>`;
  item.history.forEach((entry,i)=>{
    const diff = entry.new - entry.old;
    const sign = diff >0 ? '+' : diff < 0 ? '-' : '';
    const diffClass = diff > 0 ? 'received' : diff <0 ? 'sent' : '';
    html += `<tr data-idx="${i}">
      <td>${i+1}</td>
      <td>${entry.date || ''}</td>
      <td>${entry.old || ''}</td>
      <td>${entry.new || ''}</td>
      <td class="${diffClass}"><strong>${sign}${Math.abs(diff)}</strong></td>
      <td>
        <textarea class="history-remark-edit" data-idx="${i}" style="width:85%;height:40px;">${entry.remark || ''}</textarea>
        <button class="history-remark-save" data-idx="${i}" style="margin-left: 5px;">Save</button>
      </td>
      <td><button class="history-delete" data-idx="${i}" style="background:#e35b5b;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">Delete</button></td>
    </tr>`;
  });
  html+='</tbody></table>';
  return html;
}
function showItem(item){
  currentItem = item;
  itemTable.innerHTML = `
    <table>
      <thead>
        <tr><th>S.No.</th><th>Name</th><th>Stock</th><th>Page Number(s)</th><th>Actions</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>${item.sno}</td>
          <td style="position: relative;">
            <span id="nameDisplay">${item.name}</span>
            <input type="text" id="nameEdit" class="editable-name-input" value="${item.name}" style="display:none;"/>
            <button id="nameEditBtn" title="Edit Name">✎</button>
            <button id="nameSaveBtn" title="Save Name" style="display:none;">✓</button>
          </td>
          <td><input type="number" min="0" id="stockEdit" class="editable" value="${item.stock}"/></td>
          <td><input type="text" id="pageEdit" class="editable" value="${item.page}"/></td>
          <td><button class="save-btn" id="itemSaveBtn">Save</button> <button class="delete-btn" id="itemDelBtn">Delete</button></td>
        </tr>
        <tr><td colspan="5">
          <label for="notesEdit" style="font-weight:bold;">Additional Notes:</label>
          <textarea id="notesEdit" class="textarea-editable" placeholder="Additional notes">${item.notes || ''}</textarea>
        </td></tr>
      </tbody>
    </table>
    <div class="history-container">${renderHistoryTable(item)}</div>
  `;

  const nameDisplay = document.getElementById('nameDisplay');
  const nameEditInput = document.getElementById('nameEdit');
  const nameEditBtn = document.getElementById('nameEditBtn');
  const nameSaveBtn = document.getElementById('nameSaveBtn');
  nameEditBtn.onclick = () => {
    nameDisplay.style.display = 'none';
    nameEditInput.style.display = 'inline-block';
    nameEditBtn.style.display = 'none';
    nameSaveBtn.style.display = 'inline-block';
    nameEditInput.focus();
  };
  nameSaveBtn.onclick = async () => {
    const newName = nameEditInput.value.trim();
    if(newName) {
      nameDisplay.textContent = newName;
      currentItem.name = newName;
      await updateItemField('name', newName);
      populateDropdown();
    }
    nameDisplay.style.display = 'inline';
    nameEditInput.style.display = 'none';
    nameEditBtn.style.display = 'inline-block';
    nameSaveBtn.style.display = 'none';
  };
  document.getElementById('itemSaveBtn').onclick = () => saveEdits(item.sno);
  document.getElementById('itemDelBtn').onclick = () => { if(confirm('Are you sure you want to delete this stock item?')) deleteItem(item.sno); };

  // History remark save buttons
  itemTable.querySelectorAll('.history-remark-save').forEach(button => {
    button.onclick = async e => {
      const idx = parseInt(e.target.getAttribute('data-idx'));
      const textarea = itemTable.querySelector(`textarea.history-remark-edit[data-idx='${idx}']`);
      if(textarea && currentItem.history && currentItem.history[idx]){
        currentItem.history[idx].remark = textarea.value.trim();
        await saveHistoryToSheet(currentItem.name);
        alert('Remark saved.');
      }
    };
  });

  // History delete buttons
  itemTable.querySelectorAll('.history-delete').forEach(button => {
    button.onclick = async e => {
      const idx = parseInt(e.target.getAttribute('data-idx'));
      if(confirm('Are you sure you want to delete this stock change history?')){
        currentItem.history.splice(idx, 1);

        // Roll back stock to previous value or 0 if no history
        if(currentItem.history.length > 0){
          currentItem.stock = currentItem.history[currentItem.history.length - 1].new;
        } else {
          currentItem.stock = 0;
        }

        // Save stock update to main sheet
        await saveItemToSheet(currentItem);

        // Save updated history to history sheet
        await saveHistoryToSheet(currentItem.name);

        alert('Stock history deleted and stock count rolled back.');
        showItem(currentItem);
      }
    };
  });
}

async function updateItemField(field, value){
  if(!currentItem) return;
  currentItem[field] = value;
  await saveItemToSheet(currentItem);
}

async function saveEdits(sno){
  const stockInput = document.getElementById('stockEdit');
  const pageInput = document.getElementById('pageEdit');
  const notesInput = document.getElementById('notesEdit');
  const stockVal = parseInt(stockInput.value, 10);
  const pageVal = pageInput.value.trim();
  const notesVal = notesInput.value.trim();
  if (isNaN(stockVal) || stockVal < 0) return alert('Stock must be a non-negative integer.');
  if (!/^(\d+(-\d+)?)(,(\d+(-\d+)?))*$/.test(pageVal.replace(/\s/g, ''))) return alert('Invalid page numbers. Example: 1,3-5,8');
  const idx = items.findIndex(i => i.sno === sno);
  if (idx === -1) return alert('Item not found.');
  const item = items[idx];
  if (item.stock !== stockVal) {
    const now = new Date().toISOString();
    item.history.push({
      date: now,
      old: item.stock,
      new: stockVal,
      receivedSent: stockVal > item.stock ? `+${stockVal - item.stock}` : `-${item.stock - stockVal}`,
      remark: ''
    });
    item.stock = stockVal;
    await appendHistoryRow(item.name, now, item.history[item.history.length - 1]);
  }
  item.page = pageVal;
  item.notes = notesVal;
  items[idx] = item;
  await saveItemToSheet(item);
  alert(`Saved changes for "${item.name}".`);
  populateDropdown();
  showItem(item);
}

async function appendHistoryRow(itemName, timestamp, historyEntry){
  await gapi.client.sheets.spreadsheets.values.append({
    spreadsheetId: SPREADSHEET_ID,
    range: `${getHistorySheet()}!A:F`,
    valueInputOption: "RAW",
    insertDataOption: "INSERT_ROWS",
    resource: {
      values: [[itemName, timestamp, historyEntry.old, historyEntry.new, historyEntry.receivedSent, historyEntry.remark || ""]],
    },
  });
}

async function saveHistoryToSheet(itemName){
  // Clear sheet then re-append updated history for current item
  const historyRows = [];
  items.forEach(item => {
    if(item.name === itemName && item.history) {
      item.history.forEach(h => {
        historyRows.push([item.name, h.date, h.old, h.new, h.receivedSent, h.remark || ""]);
      });
    }
  });
  await gapi.client.sheets.spreadsheets.values.clear({
    spreadsheetId: SPREADSHEET_ID,
    range: `${getHistorySheet()}!A2:F`
  });
  if(historyRows.length > 0) {
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${getHistorySheet()}!A2:F`,
      valueInputOption: "RAW",
      resource: { values: historyRows }
    });
  }
}

async function saveItemToSheet(item){
  const idx = items.findIndex(i => i.sno === item.sno);
  if(idx === -1) return;
  const range = `${getItemSheet()}!A${idx+2}:E${idx+2}`;
  await gapi.client.sheets.spreadsheets.values.update({
    spreadsheetId: SPREADSHEET_ID,
    range,
    valueInputOption: 'RAW',
    resource: { values: [[item.sno, item.name, item.stock, item.page, item.notes]] }
  });
  items[idx] = item;
}

async function deleteItem(sno){
  if(!confirm('Are you sure you want to delete this stock item?')) return;
  const idx = items.findIndex(i => i.sno === sno);
  if(idx === -1) return alert('Item not found.');
  items.splice(idx,1);
  alert('Deleted item locally. Please remove its row in Google Sheets manually.');
  populateDropdown();
  itemTable.innerHTML = '';
  searchBar.value = '';
}

function downloadExcel(){
  const XLSX = window.XLSX;
  const mainHeaders = ['S.No.', 'Name of Item', 'Stock', 'Page Number(s)', 'Notes'];
  const historyHeaders = ['Date & Time', 'Old Stock', 'New Stock', 'Received/Sent', 'Remarks'];
  let data = [[...mainHeaders, 'Stock Change History']];
  data.push(['', '', '', '', '', ...historyHeaders]);

  items.forEach(item => {
    const history = item.history || [];
    if(history.length === 0){
      data.push([item.sno, item.name, item.stock, item.page, item.notes,'','','','','']);
    } else {
      const h0 = history[0];
      const diff0 = h0.new - h0.old;
      const sign0 = diff0 > 0 ? '+' : diff0 < 0 ? '-' : '';
      data.push([
        item.sno, item.name, item.stock, item.page, item.notes,
        h0.date || '', h0.old, h0.new, `${sign0}${Math.abs(diff0)}`, h0.remark || ''
      ]);
      for(let i = 1; i < history.length; i++){
        const h = history[i];
        const diff = h.new - h.old;
        const sign = diff > 0 ? '+' : diff < 0 ? '-' : '';
        data.push(['', '', '', '', '', h.date || '', h.old, h.new, `${sign}${Math.abs(diff)}`, h.remark || '']);
      }
    }
  });

  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!merges'] = ws['!merges'] || [];
  ws['!merges'].push({ s: {r:0,c:5}, e: {r:0,c:9}});
  ws['!cols'] = [
    {wch:6}, {wch:30}, {wch:10}, {wch:15}, {wch:30},
    {wch:20}, {wch:10}, {wch:10}, {wch:12}, {wch:30}
  ];

  Object.entries(ws).forEach(([addr, cell]) => {
    if(['F','G','H','I','J'].includes(addr.charAt(0)) && !['F1','G1','H1','I1','J1','F2','G2','H2','I2','J2'].includes(addr)){
      if(!cell.s) cell.s = {};
      cell.s.alignment = {wrapText:true,vertical:'top'};
    }
  });

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Stock Data');
  XLSX.writeFile(wb, 'e-ledger-kakinada-stock.xlsx');
}
downloadBtn.addEventListener('click', downloadExcel);

// Initialize APIs on window load
window.onload = () => {
  gapiLoaded();
  gisLoaded();
};
</script>
</body>
</html>
